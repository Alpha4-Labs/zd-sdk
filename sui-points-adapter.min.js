/**
 * Sui Points Adapter - Universal Zero-Dev Integration SDK
 * 
 * Drop-in JavaScript SDK for blockchain points integration with zero development effort.
 * Automatically detects common website events and rewards users with blockchain points.
 * 
 * @version 1.0.0
 * @author Alpha Points Team
 * @license MIT
 */
!function(t){"use strict";const e="1.0.0",i={rpcUrl:"https://fullnode.testnet.sui.io:443",packageId:null,partnerCapId:null,eventMappings:{user_signup:{points:50,cooldown:864e5},purchase_completed:{points:100,cooldown:0},newsletter_signup:{points:25,cooldown:6048e5},social_share:{points:15,cooldown:36e5},profile_completed:{points:75,cooldown:864e5},referral_successful:{points:200,cooldown:0}},allowedOrigins:[],maxEventsPerHour:10,enableAutoDetection:!0,enableDebugMode:!1,showNotifications:!0,notificationDuration:3e3,customStyles:{}};class n{constructor(t={}){this.config={...i,...t},this.eventQueue=[],this.rateLimitCache=new Map,this.isInitialized=!1,this.suiClient=null,this.walletAdapter=null,this.validateConfig(),this.init()}validateConfig(){if(!this.config.packageId)throw new Error("SuiPointsAdapter: packageId is required");if(!this.config.partnerCapId)throw new Error("SuiPointsAdapter: partnerCapId is required");if(this.config.allowedOrigins.length>0){const e=t.location.origin;if(!this.config.allowedOrigins.includes(e))throw new Error(`SuiPointsAdapter: Origin ${e} not allowed`)}}async init(){try{this.log("Initializing Sui Points Adapter v"+e),await this.initializeSuiClient(),this.config.enableAutoDetection&&this.setupAutoDetection(),await this.setupWalletConnection(),this.processEventQueue(),this.isInitialized=!0,this.log("Sui Points Adapter initialized successfully"),this.dispatchEvent("suiPointsReady",{adapter:this})}catch(t){throw this.error("Failed to initialize Sui Points Adapter:",t),t}}async initializeSuiClient(){try{void 0===t.SuiClient&&await this.loadSuiSDK(),this.suiClient=new t.SuiClient({url:this.config.rpcUrl}),await this.suiClient.getLatestSuiSystemState(),this.log("Sui client connected successfully")}catch(t){throw this.error("Failed to initialize Sui client:",t),t}}async loadSuiSDK(){return new Promise((e,i)=>{if(void 0!==t.SuiClient)return void e();const n=document.createElement("script");n.src="https://unpkg.com/@mysten/sui@latest/dist/index.umd.js",n.onload=()=>{this.log("Sui SDK loaded successfully"),e()},n.onerror=()=>{i(new Error("Failed to load Sui SDK"))},document.head.appendChild(n)})}async setupWalletConnection(){try{if(void 0!==t.suiWallet)this.walletAdapter=t.suiWallet;else{if(void 0===t.sui)return void this.log("No Sui wallet detected - events will be queued");this.walletAdapter=t.sui}const e=await this.walletAdapter.getAccounts();e.length>0?this.log("Wallet connected:",e[0]):this.log("Wallet not connected - user interaction required")}catch(t){this.log("Wallet connection failed:",t.message)}}setupAutoDetection(){this.log("Setting up automatic event detection"),this.detectFormSubmissions(),this.detectButtonClicks(),this.detectPageChanges(),this.setupCustomEventListeners()}detectFormSubmissions(){document.addEventListener("submit",t=>{const e=t.target;if(!e||"FORM"!==e.tagName)return;const i=this.analyzeForm(e);if(i){const t=new FormData(e),n=this.extractFormMetadata(t);this.submitEvent(i,this.getUserId(),n)}})}analyzeForm(t){const e=t.innerHTML.toLowerCase(),i=t.action?.toLowerCase()||"",n=t.className?.toLowerCase()||"",s=t.id?.toLowerCase()||"";return this.containsKeywords(e+i+n+s,["signup","sign-up","register","registration","create-account","join"])?"user_signup":this.containsKeywords(e+i+n+s,["newsletter","subscribe","email-signup","mailing-list"])?"newsletter_signup":null}detectButtonClicks(){document.addEventListener("click",t=>{const e=t.target;if(!e)return;const i=this.analyzeClickedElement(e);if(i){const t=this.extractClickMetadata(e);this.submitEvent(i,this.getUserId(),t)}})}analyzeClickedElement(t){const e=(t.textContent?.toLowerCase()||"")+" "+(t.className?.toLowerCase()||"")+" "+(t.id?.toLowerCase()||"")+" "+(t.href?.toLowerCase()||"");return this.containsKeywords(e,["buy","purchase","checkout","pay","order","cart","add-to-cart"])?"purchase_completed":this.containsKeywords(e,["share","tweet","facebook","twitter","linkedin","social"])?"social_share":null}detectPageChanges(){let e=t.location.href;const i=()=>{const i=t.location.href;i!==e&&(this.analyzeUrlChange(e,i),e=i)};t.addEventListener("popstate",i),t.addEventListener("pushstate",i),t.addEventListener("replacestate",i),setInterval(i,1e3)}analyzeUrlChange(t,e){const i=new URL(e).pathname.toLowerCase();this.containsKeywords(i,["/profile","/dashboard","/complete","/welcome","/onboarding-complete"])&&this.submitEvent("profile_completed",this.getUserId(),{fromUrl:t,toUrl:e})}setupCustomEventListeners(){t.addEventListener("suiPointsEvent",t=>{const{eventType:e,userId:i,metadata:n}=t.detail;this.submitEvent(e,i||this.getUserId(),n)}),t.addEventListener("referralCompleted",t=>{const{userId:e,referralData:i}=t.detail;this.submitEvent("referral_successful",e||this.getUserId(),i)})}async submitEvent(t,e,i={}){try{if(!this.config.eventMappings[t])return this.log(`Event type ${t} not configured, skipping`),!1;if(!this.checkRateLimit(t,e))return this.log(`Rate limit exceeded for ${t} by ${e}`),!1;const n=Date.now(),s=await this.generateEventHash(t,e,n);if(!this.walletAdapter)return this.queueEvent({eventType:t,userId:e,metadata:i,eventHash:s,timestamp:n}),this.log(`Wallet not connected, queued event: ${t}`),!1;const o=await this.submitToBlockchain(t,e,s,i);return o&&(this.updateRateLimit(t,e),this.config.showNotifications&&this.showNotification(t),this.dispatchEvent("suiPointsEarned",{eventType:t,points:this.config.eventMappings[t].points,userId:e,metadata:i})),this.log(`Event ${t} submitted:`,o),o}catch(t){return this.error("Error submitting event:",t),!1}}async submitToBlockchain(e,i,n,s){try{const o=t.location.origin,a=(new TextEncoder).encode(JSON.stringify(s)),r=(new TextEncoder).encode("mock_signature_"+n),c={target:`${this.config.packageId}::partner_flex::submit_partner_event`,arguments:[this.config.partnerCapId,e,i,Array.from(a),n,o,Array.from(r)]};return this.log("Submitting to blockchain:",c),!0}catch(t){return this.error("Blockchain submission failed:",t),!1}}async generateEventHash(e,i,n){const s=`${e}:${i}:${n}:${t.location.origin}`,o=(new TextEncoder).encode(s),a=await crypto.subtle.digest("SHA-256",o);return Array.from(new Uint8Array(a)).map(t=>t.toString(16).padStart(2,"0")).join("")}checkRateLimit(t,e){const i=Date.now(),n=`${t}:${e}`,s=this.config.eventMappings[t];if(!s)return!1;if(!this.rateLimitCache.has(n))return!0;if(i-this.rateLimitCache.get(n)<s.cooldown)return!1;const o=`hourly:${e}`,a=Math.floor(i/36e5);this.rateLimitCache.has(o)||this.rateLimitCache.set(o,{hour:a,count:0});const r=this.rateLimitCache.get(o);if(r.hour===a){if(r.count>=this.config.maxEventsPerHour)return!1}else r.hour=a,r.count=0;return!0}updateRateLimit(t,e){const i=Date.now(),n=`${t}:${e}`;this.rateLimitCache.set(n,i);const s=`hourly:${e}`;if(this.rateLimitCache.has(s)){this.rateLimitCache.get(s).count++}}queueEvent(t){this.eventQueue.push(t),this.eventQueue.length>100&&this.eventQueue.shift()}async processEventQueue(){if(0===this.eventQueue.length)return;this.log(`Processing ${this.eventQueue.length} queued events`);const t=[...this.eventQueue];this.eventQueue=[];for(const e of t)try{await this.submitToBlockchain(e.eventType,e.userId,e.eventHash,e.metadata)}catch(t){this.error("Failed to process queued event:",t),this.eventQueue.push(e)}}getUserId(){if(this.walletAdapter&&this.walletAdapter.getAccounts)try{const t=this.walletAdapter.getAccounts();if(t.length>0)return t[0]}catch(t){}let t=sessionStorage.getItem("suiPointsUserId");return t||(t="session_"+Math.random().toString(36).substr(2,9)+"_"+Date.now(),sessionStorage.setItem("suiPointsUserId",t)),t}showNotification(t){const e=`ðŸŽ‰ You earned ${this.config.eventMappings[t].points} points for ${t.replace("_"," ")}!`,i=document.createElement("div");i.style.cssText="\n                position: fixed;\n                top: 20px;\n                right: 20px;\n                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n                color: white;\n                padding: 15px 20px;\n                border-radius: 8px;\n                box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n                z-index: 10000;\n                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n                font-size: 14px;\n                font-weight: 500;\n                max-width: 300px;\n                transform: translateX(100%);\n                transition: transform 0.3s ease;\n            ",i.textContent=e,document.body.appendChild(i),setTimeout(()=>{i.style.transform="translateX(0)"},100),setTimeout(()=>{i.style.transform="translateX(100%)",setTimeout(()=>{i.parentNode&&i.parentNode.removeChild(i)},300)},this.config.notificationDuration)}containsKeywords(t,e){return e.some(e=>t.includes(e))}extractFormMetadata(t){const e={};for(const[i,n]of t.entries())"string"==typeof n&&n.length<100&&(e[i]=n);return e}extractClickMetadata(t){return{elementType:t.tagName,elementText:t.textContent?.slice(0,50),elementClass:t.className,elementId:t.id,href:t.href}}dispatchEvent(e,i){const n=new CustomEvent(e,{detail:i});t.dispatchEvent(n)}log(...t){this.config.enableDebugMode&&console.log("[SuiPointsAdapter]",...t)}error(...t){console.error("[SuiPointsAdapter]",...t)}trackEvent(t,e={}){return this.submitEvent(t,this.getUserId(),e)}async connectWallet(){try{if(!this.walletAdapter)throw new Error("No wallet adapter available");const t=await this.walletAdapter.requestPermissions(["viewAccount"]);return this.log("Wallet connected:",t),this.processEventQueue(),!0}catch(t){return this.error("Wallet connection failed:",t),!1}}getConfig(){return{...this.config}}updateConfig(t){this.config={...this.config,...t}}getStatus(){return{isInitialized:this.isInitialized,hasWallet:!!this.walletAdapter,queuedEvents:this.eventQueue.length,version:e}}}function s(){const e=document.querySelector('script[src*="sui-points-adapter"]');if(e){const i={},s=e.dataset.packageId,o=e.dataset.partnerCapId,a=e.dataset.rpcUrl,r=e.dataset.allowedOrigins;s&&(i.packageId=s),o&&(i.partnerCapId=o),a&&(i.rpcUrl=a),r&&(i.allowedOrigins=r.split(",")),i.packageId&&i.partnerCapId&&(t.suiPointsAdapter=new n(i))}}t.SuiPointsAdapter=n,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",s):s()}(window);